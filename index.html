<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drana-Infinity</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link rel="icon" type="image/png" href="/static/logo.png">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

<style>
  * {margin:0; padding:0; box-sizing:border-box; font-family: 'Courier New', monospace;}
  body {
    background: url("/static/background.png") no-repeat center center fixed;
    background-size: cover;
    color: #0ff;
    height: 100vh;
    display: flex;
    overflow: hidden;
    position: relative;
  }

  #settings-btn {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: none;
    border: none;
    color: #0ff;
    font-size: 18px; 
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s;
  }
  #settings-btn:hover {
    opacity: 1;
  }

  #header {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px;
    border-bottom: 1px solid #0ff;
    background: #111;
  }

  .header-logo {
    width: 40px;
    height: 40px;
    margin-right: 10px;
    border-radius: 50%;
    border: 1px solid rgba(0, 255, 255, 0.418);
  }

  .header-title {
    font-size: 20px;
    font-weight: bold;
    align-self: center;
    color: rgb(30, 255, 0);
  }

  #sidebar {width:300px; background:#111; border-right:1px solid #0ff; transition: width 0.3s; display:flex; flex-direction:column;}
  #sidebar.hide {width:0; overflow:hidden;}
  #sidebar h2 {text-align:center; padding:15px; color:#0ff; font-weight:bold;}
  #chat-list {flex:1; overflow-y:auto; padding:10px;}
  .chat-item {
    padding:10px;
    margin-bottom:5px;
    background:#000c;
    cursor:pointer;
    border-radius:5px;
    transition:0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .chat-item:hover {background:#00ffff33;}
  .chat-item.active {background:#0ff; color:#000;}

  .chat-item-title {
    flex-grow: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .chat-item-actions {
    display: flex;
    gap: 5px;
  }
  .chat-item-actions button {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    font-size: 12px;
    opacity: 0.7;
    transition: 0.2s;
  }
  .chat-item-actions button:hover {
    opacity: 1;
  }

  #sidebar-buttons {
    display: flex;
    flex-direction: column;
    padding: 10px;
    gap: 10px;
  }
  #sidebar-buttons button {
    padding: 8px 12px;
    border: none;
    width: 50%;
    align-self: center;
    background: #0ff;
    color: #000;
    font-weight: bold;
    cursor: pointer;
    border-radius: 4-px;
    transition: 0.2s;
  }
  #sidebar-buttons button:hover {
    background: #0cc;
  }

  #model-select-container {
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding: 5px 0;
  }
  #model-select-container label {
    font-size: 12px;
    color: #0ff;
  }
  #model-select {
    width: 100%;
    padding: 8px;
    background-color: #000;
    color: #0ff;
    border: 1px solid #0ff;
    border-radius: 4px;
  }

  #float-toggle {position:fixed; top:10px; left:10px; z-index:1000; background:#0ff; border:none; padding:10px; border-radius:50%; cursor:pointer; display:none;}
  #float-toggle:hover {background:#0cc;}

  #main {flex:1; display:flex; flex-direction:column; justify-content:flex-end; position:relative;}
  #messages {flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column;}

  .chat-row {display:flex; align-items:flex-start; margin-bottom:15px;}
  .chat-row.ai {justify-content:flex-start; gap:10px;}
  .chat-row.user {justify-content:flex-end; gap:10px;}

  .message {max-width:70%; padding:10px 15px 10px 50px; border-radius:10px; word-wrap:break-word;}
  .user .message {background:rgba(0, 0, 0, 0.685); color:#ffffff; border: 1px solid rgba(255, 255, 255, 0.692); padding: 10px 15px;}
  .ai .message {background:rgba(0, 0, 0, 0.685); color:rgb(184, 184, 184); border:1px solid rgba(255, 255, 255, 0.692);}
  .ai .message p {margin-bottom: 1rem;}
  
  .ai .message a {
    color: rgb(94, 255, 0); 
    text-decoration: underline;
  }
  .ai .message pre {
    position: relative;
    background-color: #23232385;
    color: rgb(148, 148, 148);
    padding: 10px;
    border-radius: 5px;
    overflow-x: auto;
    margin-top: 10px;
  }
  .ai .message pre code {
    white-space: pre-wrap;
  }
  .copy-btn, .terminal-btn {
    background: rgba(0, 0, 0, 0.5);
    color: #0ff;
    border: none;
    padding: 5px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    opacity: 0.7;
    transition: opacity 0.2s;
  }
  .copy-btn:hover, .terminal-btn:hover {
    opacity: 1;
  }
  .copy-btn i, .terminal-btn i {
    pointer-events: none;
  }

  .avatar {width:40px; height:40px; border-radius:50%; flex-shrink:0; border: 1px solid #ff0000;}

  #input-area {
    display:flex; 
    flex-wrap: wrap; 
    padding:10px; 
    border:1px solid #0ff; 
    border-radius:5px; 
    background:#111; 
    align-items: flex-end; 
    width:50%; 
    align-self:center; 
    margin-bottom:15px;
  }
  
  #attached-file-display {
    width: 100%;
    margin-bottom: 8px;
    font-size: 12px;
  }
  .file-attachment {
    background: #333;
    color: #0ff;
    padding: 5px 8px;
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }
  #remove-file-btn {
    background: #555;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    cursor: pointer;
    line-height: 16px;
    text-align: center;
    font-size: 12px;
  }
  #remove-file-btn:hover {
    background: #ff0000;
  }

  .file-attachment-msg {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid #0ff;
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
  }
  .file-attachment-msg a {
    color: #0ff;
    text-decoration: none;
  }
  .file-attachment-msg a:hover {
    text-decoration: underline;
  }
  .file-attachment-msg i {
    margin-right: 8px;
  }

  #chat-input {
    flex: 1;
    min-width: 200px; 
    padding: 8px 12px;
    border: none;
    border-radius: 5px;
    background: #000;
    color: #0ff;
    outline: none;
    font-size: 14px;
    resize: none; 
    line-height: 1.4;
    min-height: 35px; 
    max-height: 150px; 
    overflow-y: auto;
  }
  #chat-input::placeholder {color:#0aa;}
  
  #send-btn, #attach-btn {background:#0ff; border:none; color:#000; padding:8px 10px; margin-left:5px; border-radius:5px; cursor:pointer; height:35px;}
  #send-btn:hover, #attach-btn:hover {background:#0cc;}
  #file-input {display:none;}

  #processing-overlay {
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.8);
    display:flex;
    justify-content:center;
    align-items:center;
    z-index:2000;
    display:none;
  }
  #processing-overlay img {
    width:100px;
    height:100px;
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0% { transform:scale(1); opacity:1; }
    50% { transform:scale(1.2); opacity:0.7; }
    100% { transform:scale(1); opacity:1; }
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 3000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0,0,0);
    background-color: rgba(0,0,0,0.4);
    justify-content: center;
    align-items: center;
  }
  .modal-content {
    background-color: #1a1a1a;
    padding: 20px;
    border: 1px solid #0ff;
    width: 60%;
    max-width: 500px;
    border-radius: 10px;
    text-align: center;
    color: #fff;
  }
  .modal-content h2 {
    margin-bottom: 20px;
    color: #0ff; 
  }
  .modal-content input {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #0ff;
    background-color: #000;
    color: #fff;
    border-radius: 5px;
  }
  .modal-content button {
    background-color: rgb(0, 0, 0);
    color: #ffffff;
    padding: 0px 10px;
    border: 1px solid #ffffff;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
  }
  .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #0ff;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }
    .modal-header h4 {
      margin: 0;
    }
    .close-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    .close-btn:hover {
        color: #f00;
    }

    .t-light { color: rgb(4, 0, 255); } 
    .t-bright { color: #09ff00; } 
    .t-white { color: #ffffff; }

    #terminal-output {
      background-color: #000;
      color: rgb(195, 255, 195); 
      padding: 10px;
      border: 1px solid #0ff;
      border-radius: 5px;
      overflow-y: auto;
      min-height: 50vh;
      max-height: 70vh;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: monospace;
      text-align: left;
    }
    .ai .message-actions {
      display: flex;
      justify-content: flex-start;
      margin-top: 5px;
    }
    .ai .show-terminal-btn {
      background-color: #0ff;
      color: #000;
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
    }
    .ai .show-terminal-btn:hover {
      background-color: rgb(0, 0, 0);
      color:#f00;
    }
    .terminal-actions {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .terminal-actions button {
      background-color: rgb(0, 0, 0);
      color: #ffffff;
      padding: 8px 12px;
      border: 1px solid #ffffff;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    .terminal-actions button:hover {
      background-color: rgb(0, 0, 0);
      color:#f00;
    }

    .processing-animation {
      font-size: 14px;
      color: #0ff;
      white-space: pre;
    }
    .processing-animation::after {
      content: ' . . .';
      animation: dots 1s steps(3, end) infinite;
    }
    @keyframes dots {
      0%, 20% { content: ' '; }
      40% { content: ' .'; }
      60% { content: ' . .'; }
      80%, 100% { content: ' . . .'; }
    }

    #settings-modal .modal-content {
      text-align: center;
      color: #fff; 
    }
    #settings-modal img {
      width: 140px;
      height: 140px;
      margin-bottom: 15px;
      border-radius: 50%;
    }
    #settings-modal p {
      color: #ccc;
      font-size: 14px;
      margin-bottom: 10px;
    }
    #settings-modal a {
      color: #0ff;
      text-decoration: none;
      margin-bottom: 20px;
      display: inline-block;
    }
    #settings-modal a:hover {
      text-decoration: underline;
    }
    #settings-modal hr {
      border: 0;
      border-top: 1px solid #0ff;
      margin: 20px 0;
      opacity: 0.5;
    }
    #settings-modal .user-details {
      margin-bottom: 20px;
    }
    #settings-modal .user-details span {
      color: #fff;
      font-weight: bold;
    }
    #logout-btn {
      background-color: #ff0000;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    #logout-btn:hover {
      background-color: #cc0000;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.2s;
    }
    .modal-btn-secondary {
      background-color: #555;
      color: #fff;
    }
    .modal-btn-secondary:hover {
      background-color: #777;
    }
    .modal-btn-primary {
      background-color: #0ff;
      color: #000;
    }
    .modal-btn-primary:hover {
      background-color: #0cc;
    }
    .modal-btn-danger {
      background-color: #ff0000;
      color: #fff;
    }
    .modal-btn-danger:hover {
      background-color: #cc0000;
    }
</style>
</head>
<body>

<div id="login-modal" class="modal">
  <div class="modal-content">
    <h2>Welcome to Drana-Infinity</h2>
    <p>Please enter your username to continue.</p><br>
    <input type="text" id="username-input" placeholder="Enter your username">
    <button id="login-btn">Start Chatting</button>
  </div>
</div>

<div id="sidebar">
  <div id="header">
    <img src="/static/logo.png" alt="Logo" class="header-logo">
    <span class="header-title">Drana-Infinity</span>
  </div>
  <div id="chat-list"></div>
  <div id="sidebar-buttons">
    <div id="model-select-container">
      <label for="model-select">Select Model:</label>
      <select id="model-select"></select>
    </div>
    <button id="new-chat"><i class="fa fa-plus"></i> New Chat</button>
    <button id="toggle-sidebar"><i class="fa fa-angle-left"></i></button>
  </div>
</div>

<button id="float-toggle"><i class="fa fa-angle-right"></i></button>

<div id="main">
  <div id="messages"></div>
  <div id="input-area">
    <div id="attached-file-display"></div>
    <input type="file" id="file-input">
    <button id="attach-btn"><i class="fa fa-paperclip"></i></button>
    <textarea id="chat-input" placeholder="Ask Drana-Infinity anything..." rows="1"></textarea>
    <button id="send-btn"><i class="fa fa-paper-plane"></i></button>
  </div>
</div>

<button id="settings-btn" title="Settings"><i class="fa fa-cog"></i></button>
<div id="user-info" style="display: none;"></div> 

<div id="processing-overlay">
  <img src="/static/logo.png" alt="Processing...">
</div>

<div id="terminal-modal" class="modal">
  <div class="modal-content" style="max-width: 80%;">
    <div class="modal-header">
        <h4>Drana-infinity</h4>
        <button id="close-terminal-btn" class="close-btn">&times;</button>
    </div>
    <pre id="terminal-output"></pre>
    <div class="terminal-actions">
        <span id="processing-dots" class="processing-animation" style="display: none;">Processing</span>
        <button id="rerun-btn"><i class="fas fa-redo"></i> Rerun</button>
        <button id="copy-output-btn"><i class="fas fa-copy"></i> Copy</button>
        <button id="save-output-btn"><i class="fas fa-save"></i> Save</button>
    </div>
  </div>
</div>

<div id="settings-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
        <h4>About</h4>
        <button id="close-settings-btn" class="close-btn">&times;</button>
    </div>
    <img src="/static/iha089_logo.png" alt="IHA089 Logo">
    <h3>Drana-Infinity — A Creation of IHA089</h3><br>
    <p style="font-size: 0.9rem; color: #bbb; margin-top: -5px;">
    Built for Hackers. Powered by Intelligence.
    </p><br>
    <a href="https://iha089.org" target="_blank" rel="noopener noreferrer">https://iha089.org</a>
    <hr>
    <div class="user-details">
      Logged in as: <span id="settings-username">username</span>
    </div>
    <button id="logout-btn"><i class="fa fa-sign-out-alt"></i> Logout</button>
  </div>
</div>

<div id="rename-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
        <h4>Rename Chat</h4>
        <button id="close-rename-btn" class="close-btn">&times;</button>
    </div>
    <p style="color: #ccc; text-align: left; margin-bottom: 10px;">Enter a new title for this chat:</p>
    <input type="text" id="rename-input" placeholder="Enter new title" style="width: 100%; margin-bottom: 20px;">
    <div class="modal-actions">
        <button id="cancel-rename-btn" class="modal-btn modal-btn-secondary">Cancel</button>
        <button id="confirm-rename-btn" class="modal-btn modal-btn-primary">Rename</button>
    </div>
  </div>
</div>

<div id="delete-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
        <h4>Delete Chat</h4>
        <button id="close-delete-btn" class="close-btn">&times;</button>
    </div>
    <p style="color: #ccc; text-align: center; margin-bottom: 20px;">Are you sure you want to delete this chat?</p>
    <p id="delete-chat-title" style="color: #fff; font-weight: bold; background: #000; padding: 10px; border-radius: 5px; margin-bottom: 20px; word-break: break-all;"></p>
    <div class="modal-actions">
        <button id="cancel-delete-btn" class="modal-btn modal-btn-secondary">Cancel</button>
        <button id="confirm-delete-btn" class="modal-btn modal-btn-danger">Delete</button>
    </div>
  </div>
</div>


<script>
const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('toggle-sidebar');
const floatToggle = document.getElementById('float-toggle');
const newChatBtn = document.getElementById('new-chat');
const chatList = document.getElementById('chat-list');
const messagesContainer = document.getElementById('messages');
const chatInput = document.getElementById('chat-input'); 
const sendBtn = document.getElementById('send-btn');
const attachBtn = document.getElementById('attach-btn');
const fileInput = document.getElementById('file-input');
const overlay = document.getElementById('processing-overlay');
const loginModal = document.getElementById('login-modal');
const usernameInput = document.getElementById('username-input');
const loginBtn = document.getElementById('login-btn');
const userInfoDisplay = document.getElementById('user-info'); 
const modelSelect = document.getElementById('model-select');
const terminalModal = document.getElementById('terminal-modal');
const terminalOutput = document.getElementById('terminal-output');
const closeTerminalBtn = document.getElementById('close-terminal-btn');
const rerunBtn = document.getElementById('rerun-btn');
const copyOutputBtn = document.getElementById('copy-output-btn');
const saveOutputBtn = document.getElementById('save-output-btn');
const processingDots = document.getElementById('processing-dots');

const settingsBtn = document.getElementById('settings-btn');
const settingsModal = document.getElementById('settings-modal');
const closeSettingsBtn = document.getElementById('close-settings-btn');
const logoutBtn = document.getElementById('logout-btn');
const settingsUsername = document.getElementById('settings-username');

const renameModal = document.getElementById('rename-modal');
const closeRenameBtn = document.getElementById('close-rename-btn');
const cancelRenameBtn = document.getElementById('cancel-rename-btn');
const confirmRenameBtn = document.getElementById('confirm-rename-btn');
const renameInput = document.getElementById('rename-input');

const deleteModal = document.getElementById('delete-modal');
const closeDeleteBtn = document.getElementById('close-delete-btn');
const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
const deleteChatTitle = document.getElementById('delete-chat-title');


let activeChatId = null;
let isChatReady = false;
let currentCommand = "";
let currentAttachedFile = null; 

toggleBtn.addEventListener('click', () => { sidebar.classList.add('hide'); floatToggle.style.display = 'block'; });
floatToggle.addEventListener('click', () => { sidebar.classList.remove('hide'); floatToggle.style.display = 'none'; });
attachBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', handleFileUpload); 

document.addEventListener('DOMContentLoaded', () => {
  checkUserSession();
});

closeTerminalBtn.addEventListener('click', () => {
    terminalModal.style.display = 'none';
});

rerunBtn.addEventListener('click', () => {
    if (currentCommand) {
        const newOutputId = `output-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        
        showTerminalOutput(newOutputId, currentCommand); 
    }
});

copyOutputBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(terminalOutput.textContent).then(() => {
        copyOutputBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        setTimeout(() => {
             copyOutputBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy text:', err);
    });
});

saveOutputBtn.addEventListener('click', () => {
    const blob = new Blob([terminalOutput.textContent], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'terminal-output.txt';
    a.click();
    URL.revokeObjectURL(a.href);
});

settingsBtn.addEventListener('click', () => {
    const username = userInfoDisplay.textContent.replace('User: ', '').trim();
    settingsUsername.textContent = username || 'Guest';
    settingsModal.style.display = 'flex';
});

closeSettingsBtn.addEventListener('click', () => {
    settingsModal.style.display = 'none';
});

logoutBtn.addEventListener('click', () => {
    document.cookie = "user_hash=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
    location.reload();
});

closeRenameBtn.addEventListener('click', () => {
    renameModal.style.display = 'none';
});
cancelRenameBtn.addEventListener('click', () => {
    renameModal.style.display = 'none';
});
confirmRenameBtn.addEventListener('click', () => {
    const chatId = confirmRenameBtn.dataset.chatId;
    const newTitle = renameInput.value.trim();
    if (chatId && newTitle) {
        renameChat(chatId, newTitle);
        renameModal.style.display = 'none';
    }
});

closeDeleteBtn.addEventListener('click', () => {
    deleteModal.style.display = 'none';
});
cancelDeleteBtn.addEventListener('click', () => {
    deleteModal.style.display = 'none';
});
confirmDeleteBtn.addEventListener('click', () => {
    const chatId = confirmDeleteBtn.dataset.chatId;
    if (chatId) {
        deleteChat(chatId);
        deleteModal.style.display = 'none';
    }
});


chatInput.addEventListener('input', () => {
    chatInput.style.height = 'auto'; 
    let scrollHeight = chatInput.scrollHeight;
    let maxHeight = parseInt(window.getComputedStyle(chatInput).maxHeight);
    if (scrollHeight > maxHeight) {
        chatInput.style.height = maxHeight + 'px';
        chatInput.style.overflowY = 'auto'; 
    } else {
        chatInput.style.height = scrollHeight + 'px';
        chatInput.style.overflowY = 'hidden'; 
    }
});

async function checkUserSession() {
  try {
    const response = await fetch('/get_user_info');
    if (response.ok) {
      const data = await response.json();
      if (data.success) {
        displayUserInfo(data.username);
        fetchModels();
      } else {
        loginModal.style.display = 'flex';
      }
    } else {
      loginModal.style.display = 'flex';
    }
  } catch (err) {
    console.error('Error checking user session:', err);
    loginModal.style.display = 'flex';
  }
}

loginBtn.addEventListener('click', async () => {
  const username = usernameInput.value.trim();
  if (!username) return;

  const response = await fetch('/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username })
  });

  if (response.ok) {
    const data = await response.json();
    displayUserInfo(data.username);
    loginModal.style.display = 'none';
    fetchModels();
  } else {
    console.error('Login failed.');
  }
});

function displayUserInfo(username) {
  userInfoDisplay.textContent = `User: ${username}`;
  settingsBtn.style.display = 'block';
}

async function fetchModels() {
  const response = await fetch('/get_models');
  if (response.ok) {
    const data = await response.json();
    modelSelect.innerHTML = '';
    data.models.forEach(model => {
      const option = document.createElement('option');
      option.value = model;
      option.textContent = model;
      modelSelect.appendChild(option);
    });
    loadChats();
  } else {
    console.error('Failed to fetch models.');
  }
}

async function loadChats() {
  const response = await fetch('/get_chats');
  if (response.ok) {
    const data = await response.json();
    chatList.innerHTML = '';
    data.chats.forEach(chat => createChatItem(chat.chat_id, chat.title));
    
    if (activeChatId) {
      setActiveChat(activeChatId);
      loadChatMessages(activeChatId);
      isChatReady = true;
    } else if (data.chats.length > 0) {
      const latestChat = data.chats[0];
      setActiveChat(latestChat.chat_id);
      modelSelect.value = latestChat.model_name;
      loadChatMessages(latestChat.chat_id);
      isChatReady = true;
    } else {
      await createNewChat();
      isChatReady = true;
    }
  } else {
    console.error('Failed to load chats.');
  }
}

async function createNewChat() {
  const modelName = modelSelect.value;
  if (!modelName) {
    console.error("Please select a model first.");
    return;
  }
  const response = await fetch('/create_new_chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ model_name: modelName })
  });
  if (response.ok) {
    const data = await response.json();
    setActiveChat(data.chat_id);
    messagesContainer.innerHTML = '';
    createChatItem(data.chat_id, data.title);
    
    document.querySelectorAll('.chat-item').forEach(c => c.classList.remove('active'));
    const newActiveItem = document.querySelector(`.chat-item[data-chat-id="${data.chat_id}"]`);
    if (newActiveItem) {
        newActiveItem.classList.add('active');
    }

  } else {
    console.error('Failed to create new chat.');
  }
}
newChatBtn.addEventListener('click', createNewChat);

function createChatItem(chatId, title) {
  const chatItem = document.createElement('div');
  chatItem.classList.add('chat-item');
  chatItem.dataset.chatId = chatId;

  const titleSpan = document.createElement('span');
  titleSpan.classList.add('chat-item-title');
  titleSpan.textContent = title; 

  const actionsDiv = document.createElement('div');
  actionsDiv.classList.add('chat-item-actions');
  actionsDiv.innerHTML = `
    <button class="rename-chat-btn"><i class="fa fa-pen"></i></button>
    <button class="delete-chat-btn"><i class="fa fa-trash"></i></button>
  `;

  chatItem.appendChild(titleSpan);
  chatItem.appendChild(actionsDiv);
  
  chatList.prepend(chatItem);

  chatItem.querySelector('.rename-chat-btn').addEventListener('click', (e) => {
    e.stopPropagation();
    const currentTitle = titleSpan.textContent;
    renameInput.value = currentTitle;
    confirmRenameBtn.dataset.chatId = chatId;
    renameModal.style.display = 'flex';
  });

  chatItem.querySelector('.delete-chat-btn').addEventListener('click', (e) => {
    e.stopPropagation();
    const currentTitle = titleSpan.textContent;
    deleteChatTitle.textContent = currentTitle;
    confirmDeleteBtn.dataset.chatId = chatId;
    deleteModal.style.display = 'flex';
  });

  chatItem.addEventListener('click', () => {
    setActiveChat(chatId);
    loadChatMessages(chatId);
  });
}


function setActiveChat(chatId) {
  document.querySelectorAll('.chat-item').forEach(c => c.classList.remove('active'));
  const newActiveItem = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
  if (newActiveItem) {
    newActiveItem.classList.add('active');
  }
  activeChatId = chatId;
  clearAttachedFile();
}

async function renameChat(chatId, newTitle) {
  const response = await fetch('/rename_chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ chat_id: chatId, new_title: newTitle })
  });
  if (response.ok) {
    const titleElement = document.querySelector(`.chat-item[data-chat-id="${chatId}"] .chat-item-title`);
    if(titleElement) {
        titleElement.textContent = newTitle;
    }
  } else {
    console.error('Failed to rename chat.');
  }
}

async function deleteChat(chatId) {
  const response = await fetch('/delete_chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ chat_id: chatId })
  });
  if (response.ok) {
    document.querySelector(`.chat-item[data-chat-id="${chatId}"]`).remove();
    if (activeChatId === chatId) {
      await createNewChat();
    }
  } else {
    console.error('Failed to delete chat.');
  }
}

async function loadChatMessages(chatId) {
  messagesContainer.innerHTML = '';
  const response = await fetch('/get_chat_messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ chat_id: chatId })
  });

  if (response.ok) {
    const data = await response.json();
    data.messages.forEach(msg => {
        const fileInfo = (msg.file_path && msg.file_name) 
            ? { file_path: msg.file_path, file_name: msg.file_name } 
            : null;
        appendMessage(msg.text, msg.sender, true, fileInfo);
    });
    addTerminalAndCopyButtons();
  } else {
    console.error('Failed to load chat messages.');
  }
}


function addTerminalAndCopyButtons() {
    const codeBlocks = messagesContainer.querySelectorAll('pre');
    codeBlocks.forEach(pre => {
        if (pre.querySelector('.copy-btn') || pre.querySelector('.terminal-btn')) {
            return;
        }

        const buttonContainer = document.createElement('div');
        buttonContainer.style.position = 'absolute';
        buttonContainer.style.top = '5px';
        buttonContainer.style.right = '5px';
        buttonContainer.style.display = 'flex';
        buttonContainer.style.gap = '5px';

        const codeEl = pre.querySelector('code');
        if (!codeEl) return; 

        const command = codeEl.textContent.trim();
        const outputId = pre.dataset.outputId;

        if (command && outputId) {
            const terminalBtn = document.createElement('button');
            terminalBtn.classList.add('terminal-btn');
            terminalBtn.innerHTML = '<i class="fa fa-terminal"></i>';
            terminalBtn.title = "Show Terminal";
            terminalBtn.addEventListener('click', () => {
                showTerminalOutput(outputId, command);
            });
            buttonContainer.appendChild(terminalBtn);
        }

        const copyBtn = document.createElement('button');
        copyBtn.classList.add('copy-btn');
        copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
        copyBtn.title = "Copy Code";
        copyBtn.addEventListener('click', () => {
            const code = pre.querySelector('code').textContent;
            navigator.clipboard.writeText(code).then(() => {
                copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        });
        buttonContainer.appendChild(copyBtn);

        pre.appendChild(buttonContainer);
    });
}

function appendMessage(text, sender, isFromDB = false, fileInfo = null) {
  const msgRow = document.createElement('div');
  msgRow.classList.add('chat-row', sender);

  let fileHtml = '';
  if (fileInfo && fileInfo.file_path && fileInfo.file_name) {
    const safeFileName = DOMPurify.sanitize(fileInfo.file_name);
    fileHtml = `
      <div class="file-attachment-msg">
        <i class="fa fa-file"></i>
        <a href="${fileInfo.file_path}" target="_blank" rel="noopener noreferrer">${safeFileName}</a>
      </div>`;
  }

  if(sender === 'ai'){
    let textToRender = text;
    if (textToRender.startsWith('Response:')) {
        textToRender = textToRender.substring(9).trimStart();
    }
    let htmlContent = marked.parse(textToRender);
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlContent, 'text/html');

    doc.querySelectorAll('pre').forEach(pre => {
        if (!pre.dataset.outputId) {
            const outputId = `output-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            pre.dataset.outputId = outputId;
        }
    });

    htmlContent = doc.body.innerHTML;

    const safeHtml = DOMPurify.sanitize(htmlContent);

    msgRow.innerHTML = `
      <img src="/static/logo.png" class="avatar">
      <div class="message">${safeHtml}${fileHtml}</div> 
    `; 

  } else {
    msgRow.innerHTML = ''; 
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message');
    msgDiv.textContent = text; 
    msgRow.appendChild(msgDiv); 
    
    if (fileHtml) {
        msgDiv.insertAdjacentHTML('beforeend', fileHtml);
    }
  }

  messagesContainer.append(msgRow);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  return msgRow.querySelector('.message');
}

async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!activeChatId) {
        console.error("Please select a chat before uploading.");
        fileInput.value = ''; 
        return;
    }

    const formData = new FormData();
    formData.append('file', file);
    formData.append('chat_id', activeChatId);

    overlay.style.display = 'flex';
    try {
        const response = await fetch('/upload_file', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            currentAttachedFile = await response.json(); 
            showAttachedFile(currentAttachedFile.file_name);
        } else {
            console.error('File upload failed.');
            clearAttachedFile();
        }
    } catch (err) {
        console.error('Error uploading file:', err);
        clearAttachedFile();
    } finally {
        overlay.style.display = 'none';
    }
}

function showAttachedFile(fileName) {
    const display = document.getElementById('attached-file-display');
    const safeFileName = DOMPurify.sanitize(fileName);
    display.innerHTML = `
        <span class="file-attachment">
            <i class="fa fa-file"></i> ${safeFileName}
            <button id="remove-file-btn" title="Remove file">&times;</button>
        </span>`;
    
    document.getElementById('remove-file-btn').addEventListener('click', clearAttachedFile);
}

function clearAttachedFile() {
    currentAttachedFile = null;
    fileInput.value = ''; 
    document.getElementById('attached-file-display').innerHTML = '';
}


async function handleSendMessage() {
  const message = chatInput.value.trim();
  const modelName = modelSelect.value;
  
  if (!message && !currentAttachedFile) return;

  if (!isChatReady) {
    console.error("Please wait for the chat session to be ready. Reloading the page might help.");
    return;
  }

  if (!activeChatId) {
    await createNewChat();
  }

  const fileInfo = currentAttachedFile; 

  appendMessage(message, 'user', false, fileInfo);
  chatInput.value = '';
  chatInput.style.height = 'auto'; 
  clearAttachedFile(); 

  const aiMsg = appendMessage('', 'ai');
  let aiText = '';

  overlay.style.display = 'flex';

  try {
    const body = JSON.stringify({ 
        message: message, 
        chat_id: activeChatId, 
        model_name: modelName,
        file_path: fileInfo ? fileInfo.file_path : null,
        file_name: fileInfo ? fileInfo.file_name : null
    });

    const response = await fetch('/chat_stream', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: body
    });

    if (!response.ok) {
      const errorData = await response.text();
      throw new Error(`HTTP error! Status: ${response.status}. Response: ${errorData}`);
    }

    overlay.style.display = 'none';

    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    while (true) {
      const { done, value } = await reader.read();
      if (done) {
        break;
      }
      aiText += decoder.decode(value, { stream: true });
      
      let textToRender = aiText;
      if (textToRender.startsWith('Response:')) {
          textToRender = textToRender.substring(9).trimStart();
      }

      const safeStreamHtml = DOMPurify.sanitize(marked.parse(textToRender));
      aiMsg.innerHTML = safeStreamHtml;
      
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    let finalText = aiText;
    if (finalText.startsWith('Response:')) {
        finalText = finalText.substring(9).trimStart();
    }
    const finalSafeHtml = DOMPurify.sanitize(marked.parse(finalText));
    aiMsg.innerHTML = finalSafeHtml;
    
    const parser = new DOMParser();
    const doc = parser.parseFromString(aiMsg.innerHTML, 'text/html');
    doc.querySelectorAll('pre:not([data-output-id])').forEach(pre => {
        const outputId = `output-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        pre.dataset.outputId = outputId;
    });
    aiMsg.innerHTML = doc.body.innerHTML;
    
    addTerminalAndCopyButtons();
    loadChats();

    const codeBlock = aiMsg.querySelector('pre code');
    if (codeBlock) {
      const command = codeBlock.textContent.trim();
      const outputId = aiMsg.querySelector('pre').dataset.outputId;
      if (command && outputId) {
        console.warn("executeCommand is not defined, but AI generated a command.");
      }
    }
    
  } catch (err) {
    console.error('Error during chat stream:', err);
    aiMsg.innerHTML = 'Error: Could not connect to the Ollama model. Please check your server and network connection.';
    overlay.style.display = 'none';
  }
}

function buildTerminalPrompt(command) {
    const safeCommand = command.replace(/</g, "&lt;").replace(/>/g, "&gt;");

    const line1 = 
        `<span class="t-light">┌──</span>` +
        `<span class="t-white">(</span>` +
        `<span class="t-bright"><b>IHA089</b></span>` +
        `<span class="t-white">)</span>` +
        `<span class="t-white">-</span>` +
        `<span class="t-white">[</span>` +
        `<span class="t-bright"><b>Drana-Infinity</b></span>` +
        `<span class="t-white">]</span>\n`;

    const line2 = 
        `<span class="t-light">└─$ </span>` +
        `<span class="t-white"><b>${safeCommand}</b></span>\n\n`;
    
    return line1 + line2;
}

async function showTerminalOutput(outputId, command) {
    terminalModal.style.display = 'flex';
    const prompt = buildTerminalPrompt(command); 
    currentCommand = command;
    
    terminalOutput.innerHTML = prompt + 'Loading output...'; 
    
    processingDots.style.display = 'inline';
    rerunBtn.disabled = true;

    try {
        const response = await fetch('/get_command_output', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ output_id: outputId })
        });
        
        if (response.ok) {
            const data = await response.json();
            
            terminalOutput.innerHTML = prompt + DOMPurify.sanitize(data.output);
            
            currentCommand = data.command;
            rerunBtn.dataset.outputId = outputId;
        } else if (response.status === 404) {
            const execResponse = await fetch('/execute_stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command, chat_id: activeChatId, output_id: outputId })
            });

            if (!execResponse.ok) {
                const errorData = await execResponse.text();
                
                terminalOutput.innerHTML = prompt + DOMPurify.sanitize(`Error: ${errorData}`);
                return;
            }
            
            const reader = execResponse.body.getReader();
            const decoder = new TextDecoder();
            let output = '';
            
            terminalOutput.innerHTML = prompt; 
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                output += decoder.decode(value, { stream: true });
                
                terminalOutput.innerHTML = prompt + DOMPurify.sanitize(output);
                
                terminalOutput.scrollTop = terminalOutput.scrollHeight;
            }
            currentCommand = command;
            rerunBtn.dataset.outputId = outputId;

        } else {
            terminalOutput.innerHTML = prompt + "Error: Could not load command output.";
        }
    } catch (err) {
        console.error('Error in terminal logic:', err);

        terminalOutput.innerHTML = prompt + DOMPurify.sanitize(`Error: An unexpected error occurred. Details: ${err.message}`);
    } finally {
        rerunBtn.disabled = false;
        processingDots.style.display = 'none';
    }
}


sendBtn.addEventListener('click', handleSendMessage);
chatInput.addEventListener('keydown', e => { 
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault(); 
    handleSendMessage();
    chatInput.style.height = 'auto'; 
  }
});
</script>

</body>
</html>


